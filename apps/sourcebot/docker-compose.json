{
  "services": [
    {
      "name": "sourcebot",
      "image": "ghcr.io/sourcebot-dev/sourcebot:v4.10.28",
      "isMain": true,
      "internalPort": 3000,
      "environment": [
        {
          "key": "TZ",
          "value": "${TZ}"
        },
        {
          "key": "CONFIG_PATH",
          "value": "/data/config.json"
        },
        {
          "key": "AUTH_URL",
          "value": "${APP_PROTOCOL:-http}://${APP_DOMAIN:-localhost}"
        },
        {
          "key": "AUTH_SECRET",
          "value": "${AUTH_SECRET}"
        },
        {
          "key": "SOURCEBOT_ENCRYPTION_KEY",
          "value": "${SOURCEBOT_ENCRYPTION_KEY}"
        },
        {
          "key": "DATABASE_URL",
          "value": "postgresql://sourcebot:${SOURCEBOT_POSTGRES_PASSWORD}@sourcebot-postgres:5432/sourcebot"
        },
        {
          "key": "REDIS_URL",
          "value": "redis://sourcebot-redis:6379"
        },
        {
          "key": "OPENAI_API_KEY",
          "value": "${OPENAI_API_KEY}"
        },
        {
          "key": "ANTHROPIC_API_KEY",
          "value": "${ANTHROPIC_API_KEY}"
        },
        {
          "key": "GITHUB_TOKEN",
          "value": "${GITHUB_TOKEN}"
        },
        {
          "key": "GITHUB_APP_ID",
          "value": "${GITHUB_APP_ID}"
        },
        {
          "key": "GITHUB_APP_PRIVATE_KEY",
          "value": "${GITHUB_APP_PRIVATE_KEY}"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/app",
          "containerPath": "/data"
        }
      ],
      "dependsOn": {
        "sourcebot-postgres": {
          "condition": "service_healthy"
        },
        "sourcebot-redis": {
          "condition": "service_started"
        },
        "sourcebot-init": {
          "condition": "service_completed_successfully"
        }
      },
      "user": "1500:1500",
      "stopGracePeriod": "30s",
      "logging": {
        "driver": "json-file",
        "options": {
          "max-size": "10mb",
          "max-file": "1"
        }
      },
      "securityOpt": ["no-new-privileges:true"]
      ,
      "healthCheck": {
        "test": "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000",
        "interval": "10s",
        "timeout": "5s",
        "retries": 5,
        "startPeriod": "30s"
      }
    },
    {
      "name": "sourcebot-postgres",
      "image": "postgres:16-alpine",
      "environment": [
        {
          "key": "TZ",
          "value": "${TZ}"
        },
        {
          "key": "POSTGRES_USER",
          "value": "sourcebot"
        },
        {
          "key": "POSTGRES_PASSWORD",
          "value": "${SOURCEBOT_POSTGRES_PASSWORD}"
        },
        {
          "key": "POSTGRES_DB",
          "value": "sourcebot"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/postgres",
          "containerPath": "/var/lib/postgresql/data"
        }
      ],
      "healthCheck": {
        "test": "pg_isready -d sourcebot -U sourcebot",
        "interval": "5s",
        "timeout": "5s",
        "retries": 12,
        "startPeriod": "30s"
      }
    },
    {
      "name": "sourcebot-redis",
      "image": "redis:7-alpine",
      "environment": [
        {
          "key": "TZ",
          "value": "${TZ}"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/redis",
          "containerPath": "/data"
        }
      ]
    },
    {
      "name": "sourcebot-init",
      "image": "alpine:3.19",
      "command": [
        "sh",
        "-c",
        "if [ ! -f /data/config.json ]; then printf '%s\n' '{\"$schema\":\"https://raw.githubusercontent.com/sourcebot-dev/sourcebot/main/schemas/v3/index.json\",\"connections\":{\"starter-connection\":{\"type\":\"github\",\"repos\":[\"sourcebot-dev/sourcebot\"]}}}' > /data/config.json; fi && chown -R 1500:1500 /data"
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/app",
          "containerPath": "/data"
        }
      ],
      "restart": "no"
    }
  ],
  "schemaVersion": 2,
  "$schema": "https://schemas.runtipi.io/v2/dynamic-compose.json"
}
